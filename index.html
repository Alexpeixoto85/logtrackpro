<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogiTrack Pro - Sistema Completo de Gestão Logística</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --info: #4895ef;
            --warning: #f72585;
            --danger: #e63946;
            --dark: #1d3557;
            --light: #f1faee;
            --gray: #adb5bd;
            --sidebar-width: 280px;
            --sidebar-collapsed-width: 80px;
            --header-height: 70px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--dark);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Layout Principal */
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--dark) 0%, #14213d 100%);
            color: white;
            transition: all 0.3s ease;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar.collapsed {
            width: var(--sidebar-collapsed-width);
        }
        
        .sidebar-header {
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: var(--header-height);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-icon {
            font-size: 24px;
            color: var(--success);
        }
        
        .logo-text {
            font-size: 20px;
            font-weight: 700;
            transition: opacity 0.3s;
        }
        
        .sidebar.collapsed .logo-text {
            opacity: 0;
            width: 0;
        }
        
        .toggle-sidebar {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .sidebar.collapsed .toggle-sidebar {
            transform: rotate(180deg);
        }
        
        .sidebar-menu {
            padding: 20px 0;
            list-style: none;
        }
        
        .sidebar-menu li {
            position: relative;
        }
        
        .sidebar-menu a {
            padding: 15px 25px;
            display: flex;
            align-items: center;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }
        
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: var(--success);
            padding-left: 30px;
        }
        
        .sidebar-menu i {
            margin-right: 15px;
            width: 20px;
            text-align: center;
            font-size: 18px;
        }
        
        .sidebar.collapsed .menu-text {
            opacity: 0;
            width: 0;
        }
        
        .menu-text {
            transition: opacity 0.3s;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            transition: all 0.3s ease;
            padding: 20px;
        }
        
        .sidebar.collapsed ~ .main-content {
            margin-left: var(--sidebar-collapsed-width);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 25px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            font-size: 28px;
            color: var(--dark);
            font-weight: 700;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid var(--primary);
        }
        
        .notification-bell {
            position: relative;
            font-size: 20px;
            color: var(--dark);
            cursor: pointer;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--warning);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Cards */
        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
            padding: 25px;
            transition: all 0.3s ease;
            border-left: 5px solid var(--primary);
            position: relative;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.12);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--success));
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-title {
            font-size: 16px;
            color: var(--gray);
            font-weight: 600;
        }
        
        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 22px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .card-icon.primary {
            background: linear-gradient(135deg, var(--primary), var(--info));
        }
        
        .card-icon.success {
            background: linear-gradient(135deg, var(--success), #4cc9f0);
        }
        
        .card-icon.warning {
            background: linear-gradient(135deg, var(--warning), #f72585);
        }
        
        .card-icon.danger {
            background: linear-gradient(135deg, var(--danger), #e63946);
        }
        
        .card-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--dark);
        }
        
        .card-footer {
            font-size: 14px;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .card-footer.positive {
            color: var(--success);
        }
        
        .card-footer.negative {
            color: var(--danger);
        }
        
        /* Tables */
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
            padding: 25px;
            margin-bottom: 35px;
            overflow-x: auto;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .table-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eaeaea;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--dark);
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
        }
        
        .status.pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status.delivered {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .status.cancelled {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .status.active {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status.inactive {
            background-color: #e2e3e5;
            color: #383d41;
        }
        
        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--info));
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success), #4cc9f0);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #e63946);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #f72585);
            color: white;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
            outline: none;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background-color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 25px;
            position: relative;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            animation: modalFadeIn 0.3s;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .modal-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
        }
        
        .close-modal:hover {
            color: var(--danger);
        }
        
        /* Scanner */
        .scanner-container {
            text-align: center;
            padding: 30px;
            border: 2px dashed #ddd;
            border-radius: 12px;
            margin-bottom: 25px;
            background-color: #f9f9f9;
        }
        
        .scanner-placeholder {
            font-size: 60px;
            color: var(--gray);
            margin-bottom: 15px;
        }
        
        #scanner-preview {
            width: 100%;
            max-width: 500px;
            height: 300px;
            background-color: #000;
            margin: 0 auto 20px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #eaeaea;
            margin-bottom: 25px;
        }
        
        .tab {
            padding: 12px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Charts */
        .chart-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
            padding: 25px;
            margin-bottom: 35px;
            height: 350px;
        }
        
        /* Inactivity Modal */
        #inactivityModal .modal-content {
            max-width: 450px;
            text-align: center;
        }
        
        .inactivity-icon {
            font-size: 60px;
            color: var(--warning);
            margin-bottom: 20px;
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            .sidebar {
                width: var(--sidebar-collapsed-width);
            }
            
            .sidebar .menu-text {
                display: none;
            }
            
            .main-content {
                margin-left: var(--sidebar-collapsed-width);
            }
            
            .sidebar-header h2 {
                display: none;
            }
            
            .sidebar-menu a {
                text-align: center;
                padding: 15px 10px;
            }
            
            .sidebar-menu i {
                margin-right: 0;
                font-size: 20px;
            }
        }
        
        @media (max-width: 768px) {
            .cards {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .user-info {
                align-self: flex-end;
            }
        }
        
        /* Configurações */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
        }
        
        .setting-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
            padding: 25px;
            transition: all 0.3s;
        }
        
        .setting-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.12);
        }
        
        .setting-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .setting-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 22px;
        }
        
        .setting-icon.backup {
            background: linear-gradient(135deg, var(--primary), var(--info));
        }
        
        .setting-icon.security {
            background: linear-gradient(135deg, var(--success), #4cc9f0);
        }
        
        .setting-icon.notifications {
            background: linear-gradient(135deg, var(--warning), #f72585);
        }
        
        .setting-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .backup-options {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 3000;
        }
        
        .toast {
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 15px 20px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 300px;
            transform: translateX(400px);
            transition: transform 0.3s;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }
        
        .toast.success .toast-icon {
            background-color: var(--success);
        }
        
        .toast.error .toast-icon {
            background-color: var(--danger);
        }
        
        .toast.warning .toast-icon {
            background-color: var(--warning);
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .toast-message {
            font-size: 14px;
            color: var(--gray);
        }
        
        .close-toast {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 16px;
        }
        
        /* QR Code Scanner */
        #qr-scanner {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        
        /* Search and Filters */
        .search-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .search-box {
            flex: 1;
            min-width: 250px;
        }
        
        .filter-select {
            min-width: 200px;
        }
        
        /* Action buttons in tables */
        .action-buttons {
            display: flex;
            gap: 5px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-shipping-fast logo-icon"></i>
                    <span class="logo-text">LogiTrack Pro</span>
                </div>
                <button class="toggle-sidebar">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
            <ul class="sidebar-menu">
                <li><a href="#" class="active" data-tab="dashboard"><i class="fas fa-home"></i> <span class="menu-text">Dashboard</span></a></li>
                <li><a href="#" data-tab="empresas"><i class="fas fa-building"></i> <span class="menu-text">Empresas</span></a></li>
                <li><a href="#" data-tab="entregadores"><i class="fas fa-users"></i> <span class="menu-text">Entregadores</span></a></li>
                <li><a href="#" data-tab="mercadorias"><i class="fas fa-box"></i> <span class="menu-text">Mercadorias</span></a></li>
                <li><a href="#" data-tab="entregas"><i class="fas fa-shipping-fast"></i> <span class="menu-text">Entregas</span></a></li>
                <li><a href="#" data-tab="financeiro"><i class="fas fa-chart-line"></i> <span class="menu-text">Financeiro</span></a></li>
                <li><a href="#" data-tab="relatorios"><i class="fas fa-chart-bar"></i> <span class="menu-text">Relatórios</span></a></li>
                <li><a href="#" data-tab="configuracoes"><i class="fas fa-cog"></i> <span class="menu-text">Configurações</span></a></li>
            </ul>
        </div>

        <div class="main-content">
            <div class="header">
                <h1>Dashboard</h1>
                <div class="user-info">
                    <div class="notification-bell">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge">3</span>
                    </div>
                    <img src="https://ui-avatars.com/api/?name=Admin+User&background=4361ee&color=fff&size=128" alt="Usuário">
                    <span>Administrador</span>
                </div>
            </div>

            <div id="dashboard" class="tab-content active">
                <div class="cards">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Entregas Concluídas</div>
                            <div class="card-icon success">
                                <i class="fas fa-shipping-fast"></i>
                            </div>
                        </div>
                        <div class="card-value" id="entregasConcluidasCard">0</div>
                        <div class="card-footer positive">
                            <i class="fas fa-check"></i> Total entregue
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Entregas Pendentes</div>
                            <div class="card-icon primary">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <div class="card-value" id="entregasPendentesCard">0</div>
                        <div class="card-footer">Aguardando início</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Valor Total em Mercadorias</div>
                            <div class="card-icon warning">
                                <i class="fas fa-box"></i>
                            </div>
                        </div>
                        <div class="card-value" id="valorTotalMercadorias">R$ 0,00</div>
                        <div class="card-footer">Valor total no sistema</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Entregadores Ativos</div>
                            <div class="card-icon info">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="card-value" id="entregadoresAtivosCard">0</div>
                        <div class="card-footer positive">
                            <i class="fas fa-user-check"></i> Em atividade
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <h2 class="table-title">Entregas Recentes</h2>
                        <button class="btn btn-primary" id="btnNovaEntrega">
                            <i class="fas fa-plus"></i> Nova Entrega
                        </button>
                    </div>
                    <table id="entregasTable">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Empresa</th>
                                <th>Entregador</th>
                                <th>Data</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 35px;">
                    <div class="chart-container">
                        <h2 class="table-title" style="margin-bottom: 10px; font-size: 20px;">Entregas por Status</h2>
                        <canvas id="entregasPorStatusChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h2 class="table-title" style="margin-bottom: 10px; font-size: 20px;">Entregas Registradas (6 Meses)</h2>
                        <canvas id="entregasMensaisChart"></canvas>
                    </div>
                </div>
                </div>

            <div id="empresas" class="tab-content">
                <div class="header">
                    <h1>Empresas de Logística</h1>
                    <button class="btn btn-primary" id="btnNovaEmpresa">
                        <i class="fas fa-plus"></i> Nova Empresa
                    </button>
                </div>

                <div class="search-filter">
                    <div class="search-box">
                        <input type="text" id="searchEmpresas" placeholder="Buscar empresas...">
                    </div>
                    <div class="filter-select">
                        <select id="filterEmpresas">
                            <option value="">Todas as empresas</option>
                            <option value="15">Pagamento em 15 dias</option>
                            <option value="30">Pagamento em 30 dias</option>
                        </select>
                    </div>
                </div>

                <div class="table-container">
                    <table id="empresasTable">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>CNPJ</th>
                                <th>Contato</th>
                                <th>Telefone</th>
                                <th>Pagamento</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="entregadores" class="tab-content">
                <div class="header">
                    <h1>Entregadores</h1>
                    <button class="btn btn-primary" id="btnNovoEntregador">
                        <i class="fas fa-plus"></i> Novo Entregador
                    </button>
                </div>

                <div class="search-filter">
                    <div class="search-box">
                        <input type="text" id="searchEntregadores" placeholder="Buscar entregadores...">
                    </div>
                    <div class="filter-select">
                        <select id="filterEntregadores">
                            <option value="">Todos os status</option>
                            <option value="ativo">Ativos</option>
                            <option value="inativo">Inativos</option>
                        </select>
                    </div>
                </div>

                <div class="table-container">
                    <table id="entregadoresTable">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>CPF</th>
                                <th>Telefone</th>
                                <th>Veículo</th>
                                <th>Comissão</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="mercadorias" class="tab-content">
                <div class="header">
                    <h1>Mercadorias</h1>
                    <div>
                        <button class="btn btn-warning" id="btnScanner">
                            <i class="fas fa-camera"></i> Scanner
                        </button>
                        <button class="btn btn-primary" id="btnNovaMercadoria">
                            <i class="fas fa-plus"></i> Nova Mercadoria
                        </button>
                    </div>
                </div>

                <div class="scanner-container" id="scannerContainer" style="display: none;">
                    <div id="scanner-preview"></div>
                    <p>Posicione o código de barras ou QR Code na frente da câmera</p>
                    <button class="btn btn-secondary" id="btnIniciarScanner">Iniciar Scanner</button>
                    <button class="btn btn-danger" id="btnPararScanner">Parar Scanner</button>
                    <div id="scanner-result" style="margin-top: 15px;"></div>
                </div>

                <div class="search-filter">
                    <div class="search-box">
                        <input type="text" id="searchMercadorias" placeholder="Buscar mercadorias...">
                    </div>
                    <div class="filter-select">
                        <select id="filterMercadorias">
                            <option value="">Todos os status</option>
                            <option value="pendente">Pendentes</option>
                            <option value="entregue">Entregues</option>
                            <option value="cancelado">Cancelados</option>
                        </select>
                    </div>
                </div>

                <div class="table-container">
                    <table id="mercadoriasTable">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Descrição</th>
                                <th>Empresa</th>
                                <th>Destinatário</th>
                                <th>Data Recebimento</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="entregas" class="tab-content">
                <div class="header">
                    <h1>Controle de Entregas</h1>
                    <button class="btn btn-primary" id="btnNovaEntrega2">
                        <i class="fas fa-plus"></i> Nova Entrega
                    </button>
                </div>

                <div class="tabs">
                    <div class="tab active" data-subtab="pendentes">Pendentes</div>
                    <div class="tab" data-subtab="em-andamento">Em Andamento</div>
                    <div class="tab" data-subtab="entregues">Entregues</div>
                    <div class="tab" data-subtab="canceladas">Canceladas</div>
                </div>

                <div id="pendentes" class="subtab-content active">
                    <div class="table-container">
                        <table id="entregasPendentesTable">
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Empresa</th>
                                    <th>Entregador</th>
                                    <th>Data</th>
                                    <th>Rota</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="em-andamento" class="subtab-content">
                    <div class="table-container">
                        <table id="entregasAndamentoTable">
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Empresa</th>
                                    <th>Entregador</th>
                                    <th>Data Saída</th>
                                    <th>Rota</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="entregues" class="subtab-content">
                    <div class="table-container">
                        <table id="entregasEntreguesTable">
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Empresa</th>
                                    <th>Entregador</th>
                                    <th>Data Entrega</th>
                                    <th>Rota</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="canceladas" class="subtab-content">
                    <div class="table-container">
                        <table id="entregasCanceladasTable">
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Empresa</th>
                                    <th>Entregador</th>
                                    <th>Data</th>
                                    <th>Motivo</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="financeiro" class="tab-content">
                <div class="header">
                    <h1>Financeiro</h1>
                </div>

                <div class="cards">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">A Receber (Mês)</div>
                            <div class="card-icon success">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                        </div>
                        <div class="card-value" id="valorReceber">R$ 0,00</div>
                        <div class="card-footer">Estimativa de receitas</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">A Pagar (Mês)</div>
                            <div class="card-icon danger">
                                <i class="fas fa-hand-holding-usd"></i>
                            </div>
                        </div>
                        <div class="card-value" id="valorPagar">R$ 0,00</div>
                        <div class="card-footer">Estimativa de despesas</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Lucro Líquido (Mês)</div>
                            <div class="card-icon warning">
                                <i class="fas fa-chart-line"></i>
                            </div>
                        </div>
                        <div class="card-value" id="valorLucro">R$ 0,00</div>
                        <div class="card-footer">Receitas - Despesas</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Entregadores Ativos</div>
                            <div class="card-icon info">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="card-value" id="totalEntregadoresRelatorio">0</div>
                        <div class="card-footer">Total cadastrado</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h2 class="table-title" style="margin-bottom: 10px; font-size: 20px;">Fluxo de Caixa Mensal (6 Meses)</h2>
                    <canvas id="financeiroChart"></canvas>
                </div>

                <div class="table-container">
                    <h2 class="table-title">Fluxo de Caixa</h2>
                    <table id="fluxoCaixaTable">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Descrição</th>
                                <th>Categoria</th>
                                <th>Valor</th>
                                <th>Tipo</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="relatorios" class="tab-content">
                <div class="header">
                    <h1>Relatórios</h1>
                    <button class="btn btn-primary" id="btnGerarRelatorio">
                        <i class="fas fa-download"></i> Gerar Relatório PDF
                    </button>
                </div>

                <div class="cards">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Empresas Cadastradas</div>
                            <div class="card-icon primary">
                                <i class="fas fa-building"></i>
                            </div>
                        </div>
                        <div class="card-value" id="totalEmpresas">0</div>
                        <div class="card-footer">Total de empresas</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Total de Entregas (Entregues)</div>
                            <div class="card-icon success">
                                <i class="fas fa-shipping-fast"></i>
                            </div>
                        </div>
                        <div class="card-value" id="totalEntregasRelatorio">0</div>
                        <div class="card-footer">No histórico do sistema</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Desempenho Entregadores</div>
                            <div class="card-icon warning">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="card-value" id="totalEntregadoresDesempenho">0</div>
                        <div class="card-footer">Métricas de performance</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h2 class="table-title" style="margin-bottom: 10px; font-size: 20px;">Distribuição de Entregas por Empresa</h2>
                    <canvas id="relatoriosChart"></canvas>
                </div>

                <div class="table-container">
                    <h2 class="table-title">Resumo de Lucratividade por Empresa (Entregas Concluídas)</h2>
                    <table id="relatorioEntregasTable">
                        <thead>
                            <tr>
                                <th>Empresa</th>
                                <th>Entregas Concluídas</th>
                                <th>Receita (Total)</th>
                                <th>Comissão Paga (Total)</th>
                                <th>Lucro Estimado (Total)</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="configuracoes" class="tab-content">
                <div class="header">
                    <h1>Configurações do Sistema</h1>
                </div>
                <div class="settings-grid">
                    <div class="setting-card">
                        <div class="setting-header">
                            <div class="setting-icon backup">
                                <i class="fas fa-database"></i>
                            </div>
                            <div>
                                <h3 class="setting-title">Backup de Dados</h3>
                                <p>Faça backup dos dados do sistema</p>
                            </div>
                        </div>
                        <p>Último backup: <span id="ultimoBackup">14/06/2023 14:30</span></p>
                        <div class="backup-options">
                            <button class="btn btn-primary" id="btnBackupNow">
                                <i class="fas fa-download"></i> Fazer Backup Agora
                            </button>
                            <button class="btn btn-success" id="btnRestoreBackup">
                                <i class="fas fa-upload"></i> Restaurar Backup
                            </button>
                        </div>
                    </div>
                    <div class="setting-card">
                        <div class="setting-header">
                            <div class="setting-icon security">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div>
                                <h3 class="setting-title">Segurança</h3>
                                <p>Configurações de segurança do sistema</p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="inactivityTimeout">Tempo de Inatividade (segundos)</label>
                            <input type="number" id="inactivityTimeout" value="60" min="30" max="300">
                        </div>
                        <div class="form-group">
                            <label for="autoBackup">Backup Automático</label>
                            <select id="autoBackup">
                                <option value="enabled">Habilitado</option>
                                <option value="disabled">Desabilitado</option>
                            </select>
                        </div>
                    </div>
                    <div class="setting-card">
                        <div class="setting-header">
                            <div class="setting-icon notifications">
                                <i class="fas fa-bell"></i>
                            </div>
                            <div>
                                <h3 class="setting-title">Notificações</h3>
                                <p>Configurar notificações do sistema</p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" checked> Notificações de Entrega
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" checked> Notificações Financeiras
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox"> Notificações de Sistema
                            </label>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <h2 class="table-title">Logs do Sistema</h2>
                    <table id="logsTable">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Usuário</th>
                                <th>Ação</th>
                                <th>Detalhes</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modalEmpresa">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Nova Empresa</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="formEmpresa">
                <div class="form-group">
                    <label for="empresaNome">Nome da Empresa</label>
                    <input type="text" id="empresaNome" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="empresaCnpj">CNPJ</label>
                        <input type="text" id="empresaCnpj" required>
                    </div>
                    <div class="form-group">
                        <label for="empresaEmail">E-mail</label>
                        <input type="email" id="empresaEmail" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="empresaTelefone">Telefone</label>
                        <input type="text" id="empresaTelefone" required>
                    </div>
                    <div class="form-group">
                        <label for="empresaEndereco">Endereço</label>
                        <input type="text" id="empresaEndereco" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="empresaPagamento">Prazo de Pagamento (dias)</label>
                        <select id="empresaPagamento" required>
                            <option value="15">15 dias</option>
                            <option value="30">30 dias</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="empresaValor">Valor por Entrega</label>
                        <input type="number" id="empresaValor" step="0.01" required>
                    </div>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Salvar Empresa</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="modalEntregador">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Novo Entregador</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="formEntregador">
                <div class="form-row">
                    <div class="form-group">
                        <label for="entregadorNome">Nome Completo</label>
                        <input type="text" id="entregadorNome" required>
                    </div>
                    <div class="form-group">
                        <label for="entregadorCpf">CPF</label>
                        <input type="text" id="entregadorCpf" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="entregadorTelefone">Telefone</label>
                        <input type="text" id="entregadorTelefone" required>
                    </div>
                    <div class="form-group">
                        <label for="entregadorVeiculo">Veículo</label>
                        <select id="entregadorVeiculo" required>
                            <option value="moto">Moto</option>
                            <option value="carro">Carro</option>
                            <option value="bicicleta">Bicicleta</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="entregadorComissao">Comissão por Entrega</label>
                        <input type="number" id="entregadorComissao" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="entregadorStatus">Status</label>
                        <select id="entregadorStatus" required>
                            <option value="ativo">Ativo</option>
                            <option value="inativo">Inativo</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Salvar Entregador</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="modalMercadoria">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Nova Mercadoria</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="formMercadoria">
                <div class="form-row">
                    <div class="form-group">
                        <label for="mercadoriaCodigo">Código de Rastreio (Manual)</label>
                        <input type="text" id="mercadoriaCodigo">
                    </div>
                    <div class="form-group">
                        <label for="mercadoriaEmpresa">Empresa Contratante</label>
                        <select id="mercadoriaEmpresa" required>
                            </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="mercadoriaDescricao">Descrição da Mercadoria</label>
                    <textarea id="mercadoriaDescricao" rows="2" required></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="mercadoriaDestinatario">Destinatário</label>
                        <input type="text" id="mercadoriaDestinatario" required>
                    </div>
                    <div class="form-group">
                        <label for="mercadoriaEndereco">Endereço de Entrega</label>
                        <input type="text" id="mercadoriaEndereco" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="mercadoriaValor">Valor da Mercadoria (para cálculo de seguro/taxa)</label>
                        <input type="number" id="mercadoriaValor" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="mercadoriaStatus">Status Inicial</label>
                        <select id="mercadoriaStatus" required>
                            <option value="pendente">Pendente de Entrega</option>
                            <option value="em-transito">Em Trânsito</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Salvar Mercadoria</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="modalEntrega">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Nova Entrega / Montar Rota</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="formEntrega">
                <div class="form-group">
                    <label for="entregaMercadoria">Mercadoria a Ser Entregue</label>
                    <select id="entregaMercadoria" required>
                        </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="entregaEmpresa">Empresa Contratante</label>
                        <select id="entregaEmpresa" required>
                            </select>
                    </div>
                    <div class="form-group">
                        <label for="entregaEntregador">Entregador Responsável</label>
                        <select id="entregaEntregador" required>
                            </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="entregaRota">Descrição da Rota</label>
                        <input type="text" id="entregaRota" placeholder="Ex: Rota Centro/Barra" required>
                    </div>
                    <div class="form-group">
                        <label for="entregaData">Data Prevista de Entrega</label>
                        <input type="date" id="entregaData" required>
                    </div>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Salvar Entrega</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="inactivityModal">
        <div class="modal-content">
            <div class="inactivity-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h2 class="modal-title">Sua Sessão Expirará em Breve</h2>
            <p>Sua sessão está prestes a expirar devido à inatividade. Deseja continuar?</p>
            <div style="display: flex; justify-content: space-around; margin-top: 20px;">
                <button class="btn btn-primary" id="btnStayActive">Continuar Ativo</button>
                <button class="btn btn-danger" id="btnLogout">Sair e Fazer Backup</button>
            </div>
        </div>
    </div>

    <div class="toast-container"></div>

    <script>
        // Variáveis de controle de gráficos (para evitar duplicação)
        let barChartInstance;
        let lineChartInstance;
        let financeiroChartInstance;
        let relatoriosChartInstance;
        
        // Dados do sistema (simulando um banco de dados)
        let systemData = {
            empresas: [
                { id: 1, nome: "LogiExpress", cnpj: "12.345.678/0001-90", email: "contato@logiexpress.com", telefone: "(11) 9999-8888", endereco: "Rua A, 123", pagamento: "15", valorEntrega: 25.00 },
                { id: 2, nome: "FastDelivery", cnpj: "98.765.432/0001-10", email: "comercial@fastdelivery.com", telefone: "(11) 7777-6666", endereco: "Av. B, 456", pagamento: "30", valorEntrega: 30.00 },
                { id: 3, nome: "SpeedLog", cnpj: "11.222.333/0001-44", email: "faleconosco@speedlog.com", telefone: "(11) 5555-4444", endereco: "Rua C, 789", pagamento: "15", valorEntrega: 22.50 }
            ],
            entregadores: [
                { id: 101, nome: "João Silva", cpf: "123.456.789-00", telefone: "(11) 98765-4321", veiculo: "moto", comissao: 5.00, status: "ativo" },
                { id: 102, nome: "Maria Oliveira", cpf: "987.654.321-00", telefone: "(11) 96543-2109", veiculo: "carro", comissao: 7.50, status: "ativo" },
                { id: 103, nome: "Carlos Souza", cpf: "111.222.333-44", telefone: "(11) 91111-2222", veiculo: "bicicleta", comissao: 3.00, status: "inativo" }
            ],
            mercadorias: [
                { id: 1, codigo: "AB12345678BR", empresaId: 1, descricao: "Caixa de Documentos", destinatario: "Pedro Alvares", endereco: "Rua do Mar, 10", valor: 150.00, dataRecebimento: "2023-11-20", status: "entregue" },
                { id: 2, codigo: "CD98765432BR", empresaId: 2, descricao: "Peça Automotiva", destinatario: "Ana Costa", endereco: "Av. do Sol, 55", valor: 850.50, dataRecebimento: "2023-11-21", status: "em-transito" },
                { id: 3, codigo: "EF11223344BR", empresaId: 1, descricao: "Material de Escritório", destinatario: "Setor Z", endereco: "Rua da Paz, 99", valor: 50.00, dataRecebimento: "2023-11-22", status: "pendente" },
                { id: 4, codigo: "GH55667788BR", empresaId: 3, descricao: "Vestuário", destinatario: "Loja K", endereco: "Rua da Moda, 20", valor: 250.00, dataRecebimento: "2023-11-23", status: "pendente" }
            ],
            entregas: [
                { id: 1, codigo: "#ENT00001", empresaId: 1, entregadorId: 101, mercadoriaId: 1, rota: "Zona Sul", data: "2023-11-21", dataCriacao: "2023-11-19T10:00:00Z", dataSaida: "2023-11-21T08:00:00Z", dataEntrega: "2023-11-21T14:30:00Z", status: "entregue" },
                { id: 2, codigo: "#ENT00002", empresaId: 2, entregadorId: 102, mercadoriaId: 2, rota: "Zona Norte", data: "2023-11-24", dataCriacao: "2023-11-21T12:00:00Z", dataSaida: "2023-11-23T10:00:00Z", dataEntrega: null, status: "em-andamento" },
                { id: 3, codigo: "#ENT00003", empresaId: 1, entregadorId: 101, mercadoriaId: 3, rota: "Centro", data: "2023-11-25", dataCriacao: "2023-11-22T14:00:00Z", dataSaida: null, dataEntrega: null, status: "pendente" },
                { id: 4, codigo: "#ENT00004", empresaId: 3, entregadorId: 102, mercadoriaId: 4, rota: "Leste", data: "2023-11-25", dataCriacao: "2023-11-23T09:00:00Z", dataSaida: null, dataEntrega: null, status: "pendente" },
                { id: 5, codigo: "#ENT00005", empresaId: 2, entregadorId: 102, mercadoriaId: 5, rota: "Oeste", data: "2023-10-15", dataCriacao: "2023-10-10T11:00:00Z", dataSaida: "2023-10-14T08:00:00Z", dataEntrega: "2023-10-15T15:00:00Z", status: "entregue" } // Entrega antiga para teste de gráfico mensal
            ],
            financeiro: {
                entradas: [
                    { id: 1, data: "2023-11-15", descricao: "Pagamento LogiExpress (ref Out/23)", categoria: "Receita", valor: 2500.00, tipo: "entrada" },
                    { id: 2, data: "2023-11-10", descricao: "Pagamento FastDelivery (ref Out/23)", categoria: "Receita", valor: 1800.00, tipo: "entrada" },
                    { id: 3, data: "2023-10-15", descricao: "Pagamento LogiExpress (ref Set/23)", categoria: "Receita", valor: 2200.00, tipo: "entrada" }
                ],
                despesas: [
                    { id: 1, data: "2023-11-14", descricao: "Pagamento Entregadores (ref Out/23)", categoria: "Despesa", valor: 980.00, tipo: "saida" },
                    { id: 2, data: "2023-11-05", descricao: "Combustível frota (Nov/23)", categoria: "Despesa", valor: 1200.00, tipo: "saida" },
                    { id: 3, data: "2023-10-14", descricao: "Pagamento Entregadores (ref Set/23)", categoria: "Despesa", valor: 850.00, tipo: "saida" }
                ]
            },
            logs: [
                { id: 1, data: "2023-11-25 10:00", usuario: "Administrador", acao: "Login", detalhes: "Acesso ao painel" },
                { id: 2, data: "2023-11-24 16:45", usuario: "Administrador", acao: "Nova Entrega", detalhes: "Entrega #ENT00004 cadastrada" }
            ],
            config: {
                inactivityTimeout: 60000, // 60 segundos em milissegundos
                autoBackup: true,
                lastBackup: "2023-11-24 14:30"
            }
        };

        // Variáveis de controle
        let inactivityTimer;
        let lastActivity = Date.now();
        let scannerIsRunning = false;
        
        // Função para salvar dados no localStorage
        function saveDataToStorage() {
            localStorage.setItem('logitrack_data', JSON.stringify(systemData));
        }

        // Função para carregar dados do localStorage
        function loadDataFromStorage() {
            const data = localStorage.getItem('logitrack_data');
            if (data) {
                systemData = JSON.parse(data);
            } else {
                // Adicionar data de criação inicial para as mercadorias de exemplo
                systemData.mercadorias.forEach((m, index) => {
                    m.dataCriacao = new Date(new Date().setDate(new Date().getDate() - (5 - index))).toISOString();
                });
            }
        }

        // NOVO: Função para atualizar os cards do Dashboard com dados reais
        function updateDashboardCards() {
            const entregasConcluidas = systemData.entregas.filter(e => e.status === 'entregue').length;
            const entregasPendentes = systemData.entregas.filter(e => e.status === 'pendente').length;
            const entregadoresAtivos = systemData.entregadores.filter(e => e.status === 'ativo').length;
            
            let valorTotalMercadorias = 0;
            systemData.mercadorias.forEach(m => {
                if (m.valor) {
                    valorTotalMercadorias += parseFloat(m.valor);
                }
            });

            document.getElementById('entregasConcluidasCard').textContent = entregasConcluidas;
            document.getElementById('entregasPendentesCard').textContent = entregasPendentes;
            document.getElementById('entregadoresAtivosCard').textContent = entregadoresAtivos;
            document.getElementById('valorTotalMercadorias').textContent = valorTotalMercadorias.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }
        
        // NOVO: Função wrapper para renderizar todos os gráficos
        function renderAllCharts() {
            renderDashboardCharts();
            renderFinanceiroChart();
            renderRelatoriosChart();
        }

        // NOVO: Renderizar Gráficos do Dashboard
        function renderDashboardCharts() {
            // 1. Preparação dos Dados Dinâmicos
            const statusCounts = {
                'pendente': 0,
                'em-andamento': 0,
                'entregue': 0,
                'cancelado': 0
            };
            
            const date = new Date();
            const currentMonth = date.getMonth();
            const currentYear = date.getFullYear();
            
            const meses = [];
            const entregasPorMes = new Array(6).fill(0); 

            // Preenche o array de meses (Ex: Jun, Jul, Ago...)
            for (let i = 5; i >= 0; i--) {
                const targetDate = new Date(currentYear, currentMonth - i, 1);
                const mes = targetDate.toLocaleString('pt-BR', { month: 'short' });
                // Formata para primeira letra maiúscula e remove o ponto
                meses.push(mes.charAt(0).toUpperCase() + mes.slice(1).replace('.', '')); 
            }

            systemData.entregas.forEach(entrega => {
                // Contagem por Status
                if (statusCounts.hasOwnProperty(entrega.status)) {
                    statusCounts[entrega.status]++;
                }
                
                // Contagem por Mês (usando data de criação)
                if (entrega.dataCriacao) { 
                    const data = new Date(entrega.dataCriacao); 
                    const diffInMonths = (currentYear - data.getFullYear()) * 12 + (currentMonth - data.getMonth());
                    
                    if (diffInMonths >= 0 && diffInMonths < 6) {
                        entregasPorMes[5 - diffInMonths]++;
                    }
                }
            });

            // --- 2. Gráfico de Barras (Entregas por Status) ---
            const barChartData = {
                labels: ['Pendente', 'Em Trânsito', 'Entregue', 'Cancelada'],
                datasets: [{
                    label: 'Número de Entregas',
                    data: [
                        statusCounts['pendente'],
                        statusCounts['em-andamento'],
                        statusCounts['entregue'],
                        statusCounts['cancelado']
                    ],
                    backgroundColor: [
                        '#4361ee', // primary
                        '#4895ef', // info
                        '#4cc9f0', // success
                        '#f72585' // warning
                    ],
                }]
            };

            if (barChartInstance) barChartInstance.destroy();
            const ctxBar = document.getElementById('entregasPorStatusChart').getContext('2d');
            barChartInstance = new Chart(ctxBar, {
                type: 'bar',
                data: barChartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });

            // --- 3. Gráfico de Linha (Entregas por Mês) ---
            const lineChartData = {
                labels: meses, 
                datasets: [{
                    label: 'Entregas Registradas',
                    data: entregasPorMes, 
                    borderColor: '#3f37c9', 
                    tension: 0.4,
                    fill: false
                }]
            };

            if (lineChartInstance) lineChartInstance.destroy();
            const ctxLine = document.getElementById('entregasMensaisChart').getContext('2d');
            lineChartInstance = new Chart(ctxLine, {
                type: 'line',
                data: lineChartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // NOVO: Renderizar Gráfico Financeiro
        function renderFinanceiroChart() {
            // 1. Preparação dos Dados Dinâmicos
            const date = new Date();
            const currentMonth = date.getMonth();
            const currentYear = date.getFullYear();
            
            const meses = [];
            const receitasPorMes = new Array(6).fill(0);
            const despesasPorMes = new Array(6).fill(0);

            for (let i = 5; i >= 0; i--) {
                const targetDate = new Date(currentYear, currentMonth - i, 1);
                const mes = targetDate.toLocaleString('pt-BR', { month: 'short' });
                meses.push(mes.charAt(0).toUpperCase() + mes.slice(1).replace('.', '')); 
            }

            // Calcular Receitas (entradas)
            systemData.financeiro.entradas.forEach(item => {
                const data = new Date(item.data); 
                const diffInMonths = (currentYear - data.getFullYear()) * 12 + (currentMonth - data.getMonth());
                
                if (diffInMonths >= 0 && diffInMonths < 6) {
                    receitasPorMes[5 - diffInMonths] += item.valor;
                }
            });

            // Calcular Despesas (saidas)
            systemData.financeiro.despesas.forEach(item => {
                const data = new Date(item.data); 
                const diffInMonths = (currentYear - data.getFullYear()) * 12 + (currentMonth - data.getMonth());
                
                if (diffInMonths >= 0 && diffInMonths < 6) {
                    despesasPorMes[5 - diffInMonths] += item.valor;
                }
            });

            // --- 2. Gráfico de Linha (Receitas vs Despesas) ---
            const lineChartData = {
                labels: meses,
                datasets: [{
                    label: 'Receitas',
                    data: receitasPorMes, 
                    borderColor: 'rgba(76, 201, 240, 1)',
                    backgroundColor: 'rgba(76, 201, 240, 0.1)',
                    tension: 0.3,
                    fill: true
                }, {
                    label: 'Despesas',
                    data: despesasPorMes, 
                    borderColor: 'rgba(230, 57, 70, 1)',
                    backgroundColor: 'rgba(230, 57, 70, 0.1)',
                    tension: 0.3,
                    fill: true
                }]
            };

            if (financeiroChartInstance) financeiroChartInstance.destroy();
            const financeiroCtx = document.getElementById('financeiroChart').getContext('2d');
            financeiroChartInstance = new Chart(financeiroCtx, {
                type: 'line',
                data: lineChartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });

            // Atualizar Cards Financeiros
            const valorAReceber = systemData.financeiro.entradas.filter(e => new Date(e.data).getMonth() === currentMonth).reduce((sum, item) => sum + item.valor, 0);
            const valorAPagar = systemData.financeiro.despesas.filter(e => new Date(e.data).getMonth() === currentMonth).reduce((sum, item) => sum + item.valor, 0);
            const lucro = valorAReceber - valorAPagar;

            document.getElementById('valorReceber').textContent = valorAReceber.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('valorPagar').textContent = valorAPagar.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('valorLucro').textContent = lucro.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        // NOVO: Renderizar Gráfico de Relatórios (Entregas por Empresa)
        function renderRelatoriosChart() {
            // 1. Preparação dos Dados Dinâmicos
            const empresaData = systemData.empresas.map(empresa => {
                const totalEntregas = systemData.entregas.filter(e => e.empresaId === empresa.id && e.status === 'entregue').length;
                return {
                    label: empresa.nome,
                    count: totalEntregas,
                    id: empresa.id
                };
            }).filter(d => d.count > 0); 

            const labels = empresaData.map(d => d.label);
            const data = empresaData.map(d => d.count);
            
            // --- 2. Gráfico de Rosca (Entregas por Empresa) ---
            const doughnutChartData = {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        'rgba(67, 97, 238, 0.7)', // primary
                        'rgba(76, 201, 240, 0.7)', // success
                        'rgba(247, 37, 133, 0.7)', // warning
                        'rgba(230, 57, 70, 0.7)', // danger
                        'rgba(189, 189, 189, 0.7)' // gray (fallback)
                    ],
                    borderColor: 'white',
                    borderWidth: 1
                }]
            };

            if (relatoriosChartInstance) relatoriosChartInstance.destroy();
            const relatoriosCtx = document.getElementById('relatoriosChart').getContext('2d');
            relatoriosChartInstance = new Chart(relatoriosCtx, {
                type: 'doughnut',
                data: doughnutChartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });
        }
        
        // Renderizar empresas na tabela
        function renderEmpresas() {
            filterEmpresas();
        }

        // Renderizar entregadores na tabela
        function renderEntregadores() {
            filterEntregadores();
            document.getElementById('totalEntregadoresRelatorio').textContent = systemData.entregadores.length;
        }

        // Renderizar mercadorias na tabela
        function renderMercadorias() {
            filterMercadorias();
        }

        // Renderizar entregas
        function renderEntregas() {
            renderEntregasTable('entregasTable', systemData.entregas);
            renderEntregasTable('entregasPendentesTable', systemData.entregas.filter(e => e.status === 'pendente'));
            renderEntregasTable('entregasAndamentoTable', systemData.entregas.filter(e => e.status === 'em-andamento'));
            renderEntregasTable('entregasEntreguesTable', systemData.entregas.filter(e => e.status === 'entregue'));
            renderEntregasTable('entregasCanceladasTable', systemData.entregas.filter(e => e.status === 'cancelado'));
        }

        function renderEntregasTable(tableId, entregas) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            if (!tbody) return;
            tbody.innerHTML = '';

            // Limitar a tabela principal (dashboard) a 5 itens recentes
            const isDashboardTable = tableId === 'entregasTable';
            const deliveredSorted = entregas.sort((a, b) => new Date(b.dataCriacao) - new Date(a.dataCriacao));
            const itemsToRender = isDashboardTable ? deliveredSorted.slice(0, 5) : entregas;
            
            itemsToRender.forEach(entrega => {
                const empresa = systemData.empresas.find(e => e.id === entrega.empresaId);
                const entregador = systemData.entregadores.find(e => e.id === entrega.entregadorId);
                const mercadoria = systemData.mercadorias.find(m => m.id === entrega.mercadoriaId);
                const tr = document.createElement('tr');
                
                let acoes = '';
                let statusClass = '';
                let statusText = '';
                
                if (entrega.status === 'pendente') {
                    acoes = `<button class="btn btn-secondary btn-sm" onclick="iniciarEntrega(${entrega.id})"> <i class="fas fa-play"></i> Iniciar Entrega </button>`;
                    statusClass = 'pending';
                    statusText = 'Pendente';
                } else if (entrega.status === 'em-andamento') {
                    acoes = `<button class="btn btn-primary btn-sm" onclick="finalizarEntrega(${entrega.id})"> <i class="fas fa-check"></i> Dar Baixa </button>`;
                    statusClass = 'delivered';
                    statusText = 'Em Andamento';
                } else if (entrega.status === 'entregue') {
                    acoes = `<button class="btn btn-secondary btn-sm" onclick="verDetalhesEntrega(${entrega.id})"> <i class="fas fa-eye"></i> Detalhes </button>`;
                    statusClass = 'active';
                    statusText = 'Entregue';
                } else if (entrega.status === 'cancelado') {
                    acoes = `<button class="btn btn-danger btn-sm" onclick="deleteEntrega(${entrega.id})"> <i class="fas fa-trash"></i> Excluir </button>`;
                    statusClass = 'cancelled';
                    statusText = 'Cancelada';
                }

                tr.innerHTML = `
                    <td>${entrega.codigo}</td>
                    <td>${empresa ? empresa.nome : 'N/A'}</td>
                    <td>${entregador ? entregador.nome : 'N/A'}</td>
                    <td>${entrega.data}</td>
                    <td><span class="status ${statusClass}">${statusText}</span></td>
                    <td class="action-buttons">${acoes}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Renderizar financeiro
        function renderFinanceiro() {
            const tbody = document.querySelector('#fluxoCaixaTable tbody');
            tbody.innerHTML = '';
            
            const transacoes = [
                ...systemData.financeiro.entradas.map(t => ({ ...t, tipo: 'entrada' })),
                ...systemData.financeiro.despesas.map(t => ({ ...t, tipo: 'saida' }))
            ].sort((a, b) => new Date(b.data) - new Date(a.data));

            transacoes.forEach(t => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${t.data}</td>
                    <td>${t.descricao}</td>
                    <td>${t.categoria}</td>
                    <td style="color: ${t.tipo === 'entrada' ? 'green' : 'red'};">${t.tipo === 'entrada' ? '+' : '-'} R$ ${t.valor.toFixed(2)}</td>
                    <td>${t.tipo === 'entrada' ? 'Receita' : 'Despesa'}</td>
                `;
                tbody.appendChild(tr);
            });
            
            // Valores calculados dentro de renderFinanceiroChart
        }

        // Renderizar relatórios
        function renderRelatorios() {
            document.getElementById('totalEmpresas').textContent = systemData.empresas.length;
            const entregasEntregues = systemData.entregas.filter(e => e.status === 'entregue').length;
            document.getElementById('totalEntregasRelatorio').textContent = entregasEntregues;
            document.getElementById('totalEntregadoresDesempenho').textContent = `${systemData.entregadores.length} entregadores`;
            
            // Relatório de entregas por empresa (tabela)
            const tbody = document.querySelector('#relatorioEntregasTable tbody');
            tbody.innerHTML = '';

            const empresasComLucro = systemData.empresas.map(empresa => {
                const entregasEmpresa = systemData.entregas.filter(e => e.empresaId === empresa.id && e.status === 'entregue' );
                const valorRecebido = entregasEmpresa.length * empresa.valorEntrega;
                
                const comissaoPaga = entregasEmpresa.reduce((total, entrega) => {
                    const entregador = systemData.entregadores.find(e => e.id === entrega.entregadorId);
                    // Procura a mercadoria para verificar o valor e calcular a comissão (simples)
                    return total + (entregador ? entregador.comissao : 0);
                }, 0);
                
                const lucro = valorRecebido - comissaoPaga;
                
                return {
                    nome: empresa.nome,
                    entregas: entregasEmpresa.length,
                    receita: valorRecebido,
                    comissao: comissaoPaga,
                    lucro: lucro
                };
            });

            // Adiciona linhas de empresa
            empresasComLucro.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.nome}</td>
                    <td>${item.entregas}</td>
                    <td>R$ ${item.receita.toFixed(2)}</td>
                    <td>R$ ${item.comissao.toFixed(2)}</td>
                    <td>R$ ${item.lucro.toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });
            
            // Adicionar linha de total
            const totalEntregas = empresasComLucro.reduce((sum, item) => sum + item.entregas, 0);
            const totalRecebido = empresasComLucro.reduce((sum, item) => sum + item.receita, 0);
            const totalComissao = empresasComLucro.reduce((sum, item) => sum + item.comissao, 0);
            const totalLucro = totalRecebido - totalComissao;
            
            const trTotal = document.createElement('tr');
            trTotal.style.fontWeight = 'bold';
            trTotal.innerHTML = `
                <td>Total</td>
                <td>${totalEntregas}</td>
                <td>R$ ${totalRecebido.toFixed(2)}</td>
                <td>R$ ${totalComissao.toFixed(2)}</td>
                <td>R$ ${totalLucro.toFixed(2)}</td>
            `;
            tbody.appendChild(trTotal);
        }

        // Renderizar logs
        function renderLogs() {
            const tbody = document.querySelector('#logsTable tbody');
            tbody.innerHTML = '';

            systemData.logs.slice(0, 10).forEach(log => { // Mostrar os 10 mais recentes
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${log.data.substring(0, 10)} ${log.data.substring(11, 16)}</td>
                    <td>${log.usuario}</td>
                    <td>${log.acao}</td>
                    <td>${log.detalhes}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Renderizar todos os dados nas tabelas e gráficos
        function renderAllData() {
            renderEmpresas();
            renderEntregadores();
            renderMercadorias();
            renderEntregas();
            renderFinanceiro();
            renderRelatorios();
            renderLogs();
            updateConfigDisplay();
            updateDashboardCards(); // NOVO: Atualiza cards do Dashboard
            renderAllCharts(); // NOVO: Renderiza todos os gráficos
        }
        
        // ... (o restante das funções como `setupEventListeners`, `saveEmpresa`, `iniciarEntrega`, `generatePDFReport`, etc., permanecem as mesmas ou foram ajustadas para o novo contexto) ...

        // Função de backup
        function performBackup() {
            const backup = {
                date: new Date().toISOString(),
                data: systemData
            };
            localStorage.setItem('logitrack_backup', JSON.stringify(backup));
            systemData.config.lastBackup = `${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`;
            saveDataToStorage();
            updateConfigDisplay();
        }

        // Função de restauração
        function restoreBackup() {
            const backupData = localStorage.getItem('logitrack_backup');
            if (backupData) {
                if (confirm('Tem certeza que deseja restaurar o backup? Todos os dados atuais serão substituídos.')) {
                    const backup = JSON.parse(backupData);
                    systemData = backup.data;
                    saveDataToStorage();
                    renderAllData(); 
                    addLog('Restauração de Backup', 'Sistema restaurado a partir de backup');
                    showToast('Backup Restaurado', 'Todos os dados foram restaurados com sucesso!', 'success');
                }
            } else {
                showToast('Backup Não Encontrado', 'Nenhum backup foi encontrado para restaurar.', 'error');
            }
        }
        
        // Funções para abrir modais
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
            resetInactivityTimer();
        }
        function openModalEntrega() {
            populateEmpresasSelect('entregaEmpresa');
            populateEntregadoresSelect('entregaEntregador');
            populateMercadoriasSelect('entregaMercadoria');
            openModal('modalEntrega');
        }

        // Funções para popular selects
        function populateEmpresasSelect(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '';
            systemData.empresas.forEach(empresa => {
                const option = document.createElement('option');
                option.value = empresa.id;
                option.textContent = empresa.nome;
                select.appendChild(option);
            });
        }

        function populateEntregadoresSelect(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '';
            systemData.entregadores
                .filter(e => e.status === 'ativo')
                .forEach(entregador => {
                    const option = document.createElement('option');
                    option.value = entregador.id;
                    option.textContent = entregador.nome;
                    select.appendChild(option);
                });
        }

        function populateMercadoriasSelect(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '';
            const mercadoriasDisponiveis = systemData.mercadorias.filter(m => {
                // Filtra mercadorias que ainda não estão em uma entrega pendente ou em andamento
                return m.status === 'pendente' && !systemData.entregas.some(e => e.mercadoriaId === m.id && (e.status === 'pendente' || e.status === 'em-andamento'));
            });
            
            mercadoriasDisponiveis.forEach(mercadoria => {
                const option = document.createElement('option');
                option.value = mercadoria.id;
                option.textContent = `${mercadoria.codigo} - ${mercadoria.descricao}`;
                select.appendChild(option);
            });
        }
        
        // Funções para salvar dados
        function saveEmpresa() {
            const form = document.getElementById('formEmpresa');
            const formData = new FormData(form);
            const novaEmpresa = {
                id: systemData.empresas.length > 0 ? Math.max(...systemData.empresas.map(e => e.id)) + 1 : 1,
                nome: document.getElementById('empresaNome').value,
                cnpj: document.getElementById('empresaCnpj').value,
                email: document.getElementById('empresaEmail').value,
                telefone: document.getElementById('empresaTelefone').value,
                endereco: document.getElementById('empresaEndereco').value,
                pagamento: document.getElementById('empresaPagamento').value,
                valorEntrega: parseFloat(document.getElementById('empresaValor').value)
            };
            systemData.empresas.push(novaEmpresa);
            saveDataToStorage();
            renderEmpresas();
            addLog('Nova Empresa', `Empresa "${novaEmpresa.nome}" cadastrada`);
            showToast('Empresa Salva', `Empresa "${novaEmpresa.nome}" cadastrada com sucesso!`, 'success');
            document.getElementById('formEmpresa').reset();
            document.getElementById('modalEmpresa').style.display = 'none';
        }

        function saveEntregador() {
            const form = document.getElementById('formEntregador');
            const novoEntregador = {
                id: systemData.entregadores.length > 0 ? Math.max(...systemData.entregadores.map(e => e.id)) + 1 : 101,
                nome: document.getElementById('entregadorNome').value,
                cpf: document.getElementById('entregadorCpf').value,
                telefone: document.getElementById('entregadorTelefone').value,
                veiculo: document.getElementById('entregadorVeiculo').value,
                comissao: parseFloat(document.getElementById('entregadorComissao').value),
                status: document.getElementById('entregadorStatus').value
            };
            systemData.entregadores.push(novoEntregador);
            saveDataToStorage();
            renderEntregadores();
            addLog('Novo Entregador', `Entregador "${novoEntregador.nome}" cadastrado`);
            showToast('Entregador Salvo', `Entregador "${novoEntregador.nome}" cadastrado com sucesso!`, 'success');
            document.getElementById('formEntregador').reset();
            document.getElementById('modalEntregador').style.display = 'none';
        }

        function saveMercadoria() {
            const form = document.getElementById('formMercadoria');
            const novaMercadoria = {
                id: systemData.mercadorias.length > 0 ? Math.max(...systemData.mercadorias.map(m => m.id)) + 1 : 1,
                codigo: document.getElementById('mercadoriaCodigo').value || `MANUAL-${Date.now()}`,
                empresaId: parseInt(document.getElementById('mercadoriaEmpresa').value),
                descricao: document.getElementById('mercadoriaDescricao').value,
                destinatario: document.getElementById('mercadoriaDestinatario').value,
                endereco: document.getElementById('mercadoriaEndereco').value,
                valor: parseFloat(document.getElementById('mercadoriaValor').value),
                dataRecebimento: new Date().toISOString().substring(0, 10),
                status: document.getElementById('mercadoriaStatus').value
            };
            systemData.mercadorias.push(novaMercadoria);
            saveDataToStorage();
            renderMercadorias();
            updateDashboardCards(); // Atualiza cards
            addLog('Nova Mercadoria', `Mercadoria "${novaMercadoria.descricao}" cadastrada`);
            showToast('Mercadoria Salva', `Mercadoria "${novaMercadoria.descricao}" cadastrada com sucesso!`, 'success');
            document.getElementById('formMercadoria').reset();
            document.getElementById('modalMercadoria').style.display = 'none';
        }

        function saveEntrega() {
            const novaEntrega = {
                id: systemData.entregas.length > 0 ? Math.max(...systemData.entregas.map(e => e.id)) + 1 : 1,
                codigo: `#ENT${String(systemData.entregas.length + 1).padStart(5, '0')}`,
                empresaId: parseInt(document.getElementById('entregaEmpresa').value),
                entregadorId: parseInt(document.getElementById('entregaEntregador').value),
                mercadoriaId: parseInt(document.getElementById('entregaMercadoria').value),
                rota: document.getElementById('entregaRota').value,
                data: document.getElementById('entregaData').value,
                dataCriacao: new Date().toISOString(), // NOVO: Adicionado para uso em gráficos
                dataSaida: null,
                dataEntrega: null,
                status: 'pendente' // Sempre começa como pendente
            };
            systemData.entregas.push(novaEntrega);
            
            // Atualiza o status da mercadoria para 'em-transito' ou similar, se necessário.
            const mercadoria = systemData.mercadorias.find(m => m.id === novaEntrega.mercadoriaId);
            if (mercadoria) {
                mercadoria.status = 'em-transito'; // Sinaliza que a mercadoria está sendo processada
            }

            saveDataToStorage();
            renderEntregas();
            renderAllCharts(); // Atualiza gráficos
            updateDashboardCards(); // Atualiza cards
            
            addLog('Nova Entrega', `Entrega ${novaEntrega.codigo} cadastrada`);
            showToast('Entrega Salva', `Entrega ${novaEntrega.codigo} cadastrada com sucesso!`, 'success');
            document.getElementById('formEntrega').reset();
            document.getElementById('modalEntrega').style.display = 'none';
        }

        // Funções para ações nas tabelas
        function iniciarEntrega(entregaId) {
            const entrega = systemData.entregas.find(e => e.id === entregaId);
            if (entrega) {
                entrega.status = 'em-andamento';
                entrega.dataSaida = new Date().toISOString();
                
                // Atualiza o status da mercadoria
                const mercadoria = systemData.mercadorias.find(m => m.id === entrega.mercadoriaId);
                if (mercadoria) {
                    mercadoria.status = 'em-transito';
                }

                saveDataToStorage();
                renderEntregas();
                renderAllCharts(); // Atualiza gráficos
                updateDashboardCards(); // Atualiza cards

                addLog('Entrega Iniciada', `Entrega ${entrega.codigo} iniciada`);
                showToast('Entrega Iniciada', `Entrega ${entrega.codigo} iniciada com sucesso!`, 'success');
            }
        }

        function finalizarEntrega(entregaId) {
            const entrega = systemData.entregas.find(e => e.id === entregaId);
            if (entrega) {
                entrega.status = 'entregue';
                entrega.dataEntrega = new Date().toISOString();

                // 1. Atualiza o status da mercadoria
                const mercadoria = systemData.mercadorias.find(m => m.id === entrega.mercadoriaId);
                if (mercadoria) {
                    mercadoria.status = 'entregue';
                }
                
                // 2. Registra a receita e despesa no financeiro
                const empresa = systemData.empresas.find(e => e.id === entrega.empresaId);
                const entregador = systemData.entregadores.find(e => e.id === entrega.entregadorId);
                
                const receita = {
                    id: systemData.financeiro.entradas.length > 0 ? Math.max(...systemData.financeiro.entradas.map(e => e.id)) + 1 : 1,
                    data: new Date().toISOString().substring(0, 10),
                    descricao: `Receita - Entrega ${entrega.codigo} (${empresa.nome})`,
                    categoria: 'Receita',
                    valor: empresa.valorEntrega,
                    tipo: 'entrada'
                };

                const despesa = {
                    id: systemData.financeiro.despesas.length > 0 ? Math.max(...systemData.financeiro.despesas.map(e => e.id)) + 1 : 1,
                    data: new Date().toISOString().substring(0, 10),
                    descricao: `Comissão - Entregador ${entregador.nome} (Entrega ${entrega.codigo})`,
                    categoria: 'Despesa',
                    valor: entregador.comissao,
                    tipo: 'saida'
                };
                
                systemData.financeiro.entradas.push(receita);
                systemData.financeiro.despesas.push(despesa);

                saveDataToStorage();
                renderEntregas();
                renderFinanceiro();
                renderRelatorios();
                renderAllCharts(); // Atualiza gráficos
                updateDashboardCards(); // Atualiza cards
                
                addLog('Entrega Finalizada', `Entrega ${entrega.codigo} finalizada`);
                showToast('Entrega Finalizada', `Entrega ${entrega.codigo} finalizada com sucesso!`, 'success');
            }
        }

        function cancelarEntrega(entregaId) {
            const entrega = systemData.entregas.find(e => e.id === entregaId);
            if (entrega && confirm(`Tem certeza que deseja cancelar a entrega ${entrega.codigo}?`)) {
                const motivo = prompt('Por favor, informe o motivo do cancelamento:');
                if (motivo) {
                    entrega.status = 'cancelado';
                    entrega.motivoCancelamento = motivo;

                    // Atualiza o status da mercadoria para 'pendente' para reuso
                    const mercadoria = systemData.mercadorias.find(m => m.id === entrega.mercadoriaId);
                    if (mercadoria) {
                        mercadoria.status = 'pendente';
                    }

                    saveDataToStorage();
                    renderEntregas();
                    renderAllCharts(); // Atualiza gráficos
                    updateDashboardCards(); // Atualiza cards

                    addLog('Entrega Cancelada', `Entrega ${entrega.codigo} cancelada. Motivo: ${motivo}`);
                    showToast('Entrega Cancelada', `Entrega ${entrega.codigo} cancelada com sucesso!`, 'error');
                }
            }
        }

        function deleteEntrega(id) {
            if (confirm('Tem certeza que deseja excluir permanentemente esta entrega?')) {
                systemData.entregas = systemData.entregas.filter(e => e.id !== id);
                saveDataToStorage();
                renderEntregas();
                renderAllCharts(); // Atualiza gráficos
                updateDashboardCards(); // Atualiza cards
                addLog('Entrega Excluída', `Entrega com ID ${id} excluída`);
                showToast('Entrega Excluída', 'Entrega excluída com sucesso!', 'success');
            }
        }

        function editEmpresa(id) {
            showToast('Funcionalidade', 'Edição de empresa será implementada na próxima versão', 'warning');
        }

        function deleteEmpresa(id) {
            if (confirm('Tem certeza que deseja excluir permanentemente esta empresa?')) {
                systemData.empresas = systemData.empresas.filter(e => e.id !== id);
                saveDataToStorage();
                renderEmpresas();
                addLog('Empresa Excluída', `Empresa com ID ${id} excluída`);
                showToast('Empresa Excluída', 'Empresa excluída com sucesso!', 'success');
            }
        }

        function editEntregador(id) {
            showToast('Funcionalidade', 'Edição de entregador será implementada na próxima versão', 'warning');
        }

        function deleteEntregador(id) {
            if (confirm('Tem certeza que deseja excluir este entregador?')) {
                systemData.entregadores = systemData.entregadores.filter(e => e.id !== id);
                saveDataToStorage();
                renderEntregadores();
                addLog('Entregador Excluído', `Entregador com ID ${id} excluído`);
                showToast('Entregador Excluído', 'Entregador excluído com sucesso!', 'success');
            }
        }

        function editMercadoria(id) {
            showToast('Funcionalidade', 'Edição de mercadoria será implementada na próxima versão', 'warning');
        }

        function updateMercadoriaStatus(id, newStatus) {
            const mercadoria = systemData.mercadorias.find(m => m.id === id);
            if (mercadoria) {
                if (newStatus === 'entregue') {
                    // Esta função é para dar baixa manual na mercadoria.
                    // Em um sistema real, a baixa é dada na entrega (finalizarEntrega).
                    showToast('Ação Bloqueada', 'Use a função "Dar Baixa" na seção Entregas para registrar a entrega completa.', 'error');
                    return;
                }
                
                mercadoria.status = newStatus;
                saveDataToStorage();
                renderMercadorias();
                addLog('Status Mercadoria', `Status da mercadoria ${mercadoria.codigo} alterado para ${newStatus}`);
                showToast('Status Atualizado', `Status da mercadoria ${mercadoria.codigo} atualizado!`, 'success');
            }
        }

        function verDetalhesEntrega(id) {
            showToast('Funcionalidade', 'Detalhes da entrega serão implementados na próxima versão', 'warning');
        }

        // Funções de filtro
        function filterEmpresas() {
            const searchTerm = document.getElementById('searchEmpresas').value.toLowerCase();
            const filterValue = document.getElementById('filterEmpresas').value;
            const filtered = systemData.empresas.filter(empresa => {
                const matchesSearch = empresa.nome.toLowerCase().includes(searchTerm) || empresa.cnpj.includes(searchTerm);
                const matchesFilter = filterValue === '' || empresa.pagamento === filterValue;
                return matchesSearch && matchesFilter;
            });

            const tbody = document.querySelector('#empresasTable tbody');
            tbody.innerHTML = '';
            filtered.forEach(empresa => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${empresa.nome}</td>
                    <td>${empresa.cnpj}</td>
                    <td>${empresa.email}</td>
                    <td>${empresa.telefone}</td>
                    <td>${empresa.pagamento} dias</td>
                    <td class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="editEmpresa(${empresa.id})"> <i class="fas fa-edit"></i> Editar </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteEmpresa(${empresa.id})"> <i class="fas fa-trash"></i> Excluir </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filterEntregadores() {
            const searchTerm = document.getElementById('searchEntregadores').value.toLowerCase();
            const filterValue = document.getElementById('filterEntregadores').value;
            const filtered = systemData.entregadores.filter(entregador => {
                const matchesSearch = entregador.nome.toLowerCase().includes(searchTerm) || entregador.cpf.includes(searchTerm);
                const matchesFilter = filterValue === '' || entregador.status === filterValue;
                return matchesSearch && matchesFilter;
            });

            const tbody = document.querySelector('#entregadoresTable tbody');
            tbody.innerHTML = '';
            filtered.forEach(entregador => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${entregador.nome}</td>
                    <td>${entregador.cpf}</td>
                    <td>${entregador.telefone}</td>
                    <td>${entregador.veiculo.charAt(0).toUpperCase() + entregador.veiculo.slice(1)}</td>
                    <td>R$ ${entregador.comissao.toFixed(2)}/entrega</td>
                    <td><span class="status ${entregador.status}">${entregador.status === 'ativo' ? 'Ativo' : 'Inativo'}</span></td>
                    <td class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="editEntregador(${entregador.id})"> <i class="fas fa-edit"></i> Editar </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteEntregador(${entregador.id})"> <i class="fas fa-trash"></i> Excluir </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filterMercadorias() {
            const searchTerm = document.getElementById('searchMercadorias').value.toLowerCase();
            const filterValue = document.getElementById('filterMercadorias').value;
            const filtered = systemData.mercadorias.filter(mercadoria => {
                const empresa = systemData.empresas.find(e => e.id === mercadoria.empresaId);
                const empresaNome = empresa ? empresa.nome.toLowerCase() : '';
                const matchesSearch = mercadoria.codigo.toLowerCase().includes(searchTerm) || mercadoria.descricao.toLowerCase().includes(searchTerm) || empresaNome.includes(searchTerm) || mercadoria.destinatario.toLowerCase().includes(searchTerm);
                const matchesFilter = filterValue === '' || mercadoria.status === filterValue;
                return matchesSearch && matchesFilter;
            });

            const tbody = document.querySelector('#mercadoriasTable tbody');
            tbody.innerHTML = '';
            filtered.forEach(mercadoria => {
                const empresa = systemData.empresas.find(e => e.id === mercadoria.empresaId);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${mercadoria.codigo}</td>
                    <td>${mercadoria.descricao}</td>
                    <td>${empresa ? empresa.nome : 'N/A'}</td>
                    <td>${mercadoria.destinatario}</td>
                    <td>${mercadoria.dataRecebimento}</td>
                    <td><span class="status ${mercadoria.status}">${getStatusText(mercadoria.status)}</span></td>
                    <td class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="editMercadoria(${mercadoria.id})"> <i class="fas fa-eye"></i> Detalhes </button>
                        <button class="btn btn-secondary btn-sm" onclick="updateMercadoriaStatus(${mercadoria.id}, 'entregue')"> <i class="fas fa-check"></i> Dar Baixa </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function getStatusText(status) {
            const statusMap = {
                'pendente': 'Pendente',
                'em-andamento': 'Em Andamento',
                'entregue': 'Entregue',
                'cancelado': 'Cancelado',
                'em-transito': 'Em Rota' // Novo status para mercadorias em entrega
            };
            return statusMap[status] || status;
        }

        // Funções de log e toast (sem alterações)
        function addLog(acao, detalhes) {
            const novoLog = {
                id: systemData.logs.length > 0 ? Math.max(...systemData.logs.map(l => l.id)) + 1 : 1,
                data: new Date().toISOString(),
                usuario: 'Administrador',
                acao: acao,
                detalhes: detalhes
            };
            systemData.logs.unshift(novoLog);
            saveDataToStorage();
            renderLogs();
        }

        function showToast(title, message, type) {
            const toastContainer = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.classList.add('toast', type);
            const iconHtml = type === 'success' ? '<i class="fas fa-check"></i>' : (type === 'error' ? '<i class="fas fa-times"></i>' : '<i class="fas fa-exclamation"></i>');
            toast.innerHTML = `
                <div class="toast-icon">${iconHtml}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="close-toast">&times;</button>
            `;

            toast.querySelector('.close-toast').addEventListener('click', () => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            });

            toastContainer.prepend(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Funções de inatividade e configuração
        function updateConfigDisplay() {
            document.getElementById('ultimoBackup').textContent = systemData.config.lastBackup;
            document.getElementById('inactivityTimeout').value = systemData.config.inactivityTimeout / 1000;
            document.getElementById('autoBackup').value = systemData.config.autoBackup ? 'enabled' : 'disabled';
        }

        function resetInactivityTimer() {
            lastActivity = Date.now();
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(checkInactivity, systemData.config.inactivityTimeout);
            document.getElementById('inactivityModal').style.display = 'none';
        }

        function checkInactivity() {
            const now = Date.now();
            const timeout = parseInt(document.getElementById('inactivityTimeout').value) * 1000 || systemData.config.inactivityTimeout;
            
            if (now - lastActivity >= timeout) {
                document.getElementById('inactivityModal').style.display = 'flex';
            }
        }
        
        // Função de Scanner (QuaggaJS)
        let scanner;
        function startScanner() {
            if (scannerIsRunning) return;

            const preview = document.getElementById('scanner-preview');
            preview.innerHTML = '';
            
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: preview,
                    constraints: {
                        width: 500,
                        height: 300,
                        facingMode: "environment"
                    }
                },
                decoder: {
                    readers: ["code_128_reader", "qr_code_reader", "ean_reader", "upc_reader"]
                }
            }, function (err) {
                if (err) {
                    console.error(err);
                    document.getElementById('scanner-result').textContent = `Erro ao iniciar scanner: ${err.message}`;
                    showToast('Erro no Scanner', 'Não foi possível iniciar a câmera.', 'error');
                    return;
                }
                Quagga.start();
                scannerIsRunning = true;
                document.getElementById('scanner-result').textContent = 'Scanner iniciado. Buscando código...';
            });

            Quagga.onDetected(function (result) {
                stopScanner();
                const code = result.codeResult.code;
                document.getElementById('scanner-result').textContent = `Código detectado: ${code}`;
                
                const mercadoria = systemData.mercadorias.find(m => m.codigo === code);
                if (mercadoria) {
                    showToast('Mercadoria Encontrada', `Mercadoria ${mercadoria.codigo} (${mercadoria.descricao}) carregada com sucesso!`, 'success');
                    // Aqui você implementaria a lógica para pré-preencher um formulário ou iniciar uma ação
                    // Exemplo: document.getElementById('mercadoriaCodigo').value = code;
                } else {
                    showToast('Mercadoria Não Encontrada', `Nenhuma mercadoria com código ${code} no sistema.`, 'warning');
                }
                document.getElementById('scannerContainer').style.display = 'none';
            });
        }

        function stopScanner() {
            if (scannerIsRunning) {
                Quagga.stop();
                scannerIsRunning = false;
                document.getElementById('scanner-result').textContent = 'Scanner parado.';
            }
        }

        // Função para gerar relatório PDF (usando jsPDF e html2canvas)
        async function generatePDFReport() {
            showToast('Relatório', 'Gerando relatório PDF...', 'warning');
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const element = document.getElementById('relatorios'); 
            
            // Oculta elementos que não devem aparecer no PDF
            const buttons = element.querySelectorAll('button, .header');
            buttons.forEach(btn => btn.style.display = 'none');

            await html2canvas(element, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgProps = doc.getImageProperties(imgData);
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                doc.save('relatorio_logitrack.pdf');
            });

            // Restaura os elementos
            buttons.forEach(btn => btn.style.display = '');
            addLog('Relatório Gerado', 'Relatório PDF de relatórios gerado');
            showToast('Relatório Gerado', 'O relatório foi salvo como PDF.', 'success');
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Navegação entre abas
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    document.querySelectorAll('.sidebar-menu a').forEach(item => { item.classList.remove('active'); });
                    this.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(tab => { tab.classList.remove('active'); });
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                    document.querySelector('.header h1').textContent = this.querySelector('.menu-text').textContent;
                    resetInactivityTimer();
                });
            });

            // Navegação entre subtabs (entregas)
            document.querySelectorAll('.tab[data-subtab]').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(item => { item.classList.remove('active'); });
                    this.classList.add('active');
                    document.querySelectorAll('.subtab-content').forEach(content => { content.classList.remove('active'); });
                    const subtabId = this.getAttribute('data-subtab');
                    document.getElementById(subtabId).classList.add('active');
                });
            });

            // Botões de Modal
            document.getElementById('btnNovaEmpresa').addEventListener('click', () => openModal('modalEmpresa'));
            document.getElementById('btnNovoEntregador').addEventListener('click', () => openModal('modalEntregador'));
            document.getElementById('btnNovaMercadoria').addEventListener('click', () => { populateEmpresasSelect('mercadoriaEmpresa'); openModal('modalMercadoria'); });
            document.getElementById('btnNovaEntrega').addEventListener('click', openModalEntrega);
            document.getElementById('btnNovaEntrega2').addEventListener('click', openModalEntrega);
            document.getElementById('btnBackupNow').addEventListener('click', performBackup);
            document.getElementById('btnRestoreBackup').addEventListener('click', restoreBackup);

            // Modal de inatividade
            document.getElementById('btnStayActive').addEventListener('click', function() {
                document.getElementById('inactivityModal').style.display = 'none';
                showToast('Sessão Ativa', 'Você escolheu continuar no sistema.', 'warning');
                resetInactivityTimer();
            });

            document.getElementById('btnLogout').addEventListener('click', function() {
                performBackup();
                document.getElementById('inactivityModal').style.display = 'none';
                showToast('Backup Realizado', 'Backup automático concluído. Redirecionando...', 'success');
                setTimeout(() => { alert('Sessão encerrada. Backup realizado com sucesso.'); }, 2000);
            });

            // Fechar modais
            document.querySelectorAll('.close-modal').forEach(button => {
                button.addEventListener('click', function() {
                    this.closest('.modal').style.display = 'none';
                    if (scannerIsRunning) stopScanner();
                });
            });

            // Fechar modais ao clicar fora
            window.addEventListener('click', function(e) {
                document.querySelectorAll('.modal').forEach(modal => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                        if (scannerIsRunning) stopScanner();
                    }
                });
            });

            // Formulários
            document.getElementById('formEmpresa').addEventListener('submit', function(e) { e.preventDefault(); saveEmpresa(); });
            document.getElementById('formEntregador').addEventListener('submit', function(e) { e.preventDefault(); saveEntregador(); });
            document.getElementById('formMercadoria').addEventListener('submit', function(e) { e.preventDefault(); saveMercadoria(); });
            document.getElementById('formEntrega').addEventListener('submit', function(e) { e.preventDefault(); saveEntrega(); });

            // Scanner
            document.getElementById('btnScanner').addEventListener('click', function() { 
                document.getElementById('scannerContainer').style.display = document.getElementById('scannerContainer').style.display === 'none' ? 'block' : 'none';
                if (document.getElementById('scannerContainer').style.display === 'block') {
                    document.getElementById('btnIniciarScanner').textContent = 'Iniciar Scanner';
                } else {
                    stopScanner();
                }
            });
            document.getElementById('btnIniciarScanner').addEventListener('click', function() { 
                startScanner();
                this.textContent = 'Scanner Rodando...';
            });
            document.getElementById('btnPararScanner').addEventListener('click', stopScanner);

            // Gerar relatório PDF
            document.getElementById('btnGerarRelatorio').addEventListener('click', generatePDFReport);

            // Buscas e filtros
            document.getElementById('searchEmpresas').addEventListener('input', filterEmpresas);
            document.getElementById('filterEmpresas').addEventListener('change', filterEmpresas);
            document.getElementById('searchEntregadores').addEventListener('input', filterEntregadores);
            document.getElementById('filterEntregadores').addEventListener('change', filterEntregadores);
            document.getElementById('searchMercadorias').addEventListener('input', filterMercadorias);
            document.getElementById('filterMercadorias').addEventListener('change', filterMercadorias);
            
            // Configurações
            document.getElementById('inactivityTimeout').addEventListener('change', function() {
                systemData.config.inactivityTimeout = parseInt(this.value) * 1000;
                saveDataToStorage();
                resetInactivityTimer();
            });
            document.getElementById('autoBackup').addEventListener('change', function() {
                systemData.config.autoBackup = this.value === 'enabled';
                saveDataToStorage();
            });


            // Detectar atividade do usuário
            document.addEventListener('mousemove', resetInactivityTimer);
            document.addEventListener('keypress', resetInactivityTimer);
            document.addEventListener('click', resetInactivityTimer);
            document.addEventListener('scroll', resetInactivityTimer);
        }

        // Inicialização
        window.onload = function() {
            loadDataFromStorage();
            setupEventListeners();
            renderAllData(); // Carrega todos os dados, incluindo os gráficos dinâmicos
            resetInactivityTimer();
        };
    </script>
</body>
</html>
